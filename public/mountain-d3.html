<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Mountain-d3</title>
    <style>
        * {
            margin: 0;
            padding: 0
        }
    </style>
</head>

<body>
    <a href="" id="link">23333</a>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="./script/calcMonthlyData.js"></script>
    <script src="./script/getMonthData.js"></script>
    <script>
        const svgHeadInfo =
            '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd" > ';
        const city = 'shanghai';

        d3.csv('./data/' + city + '.csv').then(val => {
            let some_month_data = getMonthData(val, 2018, 12);
            let data = [some_month_data];
            data[0].push([data[0][data[0].length - 1][0], 300]);
            data[0].unshift([data[0][0][0], 300]);
            let x = d3.scaleLinear().domain([0, 25]).range([0, window.innerWidth - 300]),
                y = d3.scaleLinear().domain([0, 400]).range([50, 450]);

            let line = d3.line()
                .x(d => x(d[0]))
                .y(d => y(d[1]))


            let svg = d3.select('body').append('div').append('svg')
                .attr("xmlns:xlink", "http://www.w3.org/1999/xlink")
                .attr('id', 'svg')
                .style('background-color', 'rgb(239, 232, 222)');

            // let svg = d3.select('body').append('svg').style('background-color', 'rgb(239, 232, 222)');
            svg.attr('width', window.innerWidth)
                .attr('height', window.innerHeight);

            let linearGradient = svg.append('defs').append('linearGradient')
                .attr('id', 'mountain-color')
                .attr('x1', '0%')
                .attr('y1', '0%')
                .attr('x2', '0%')
                .attr('y2', '100%')
                .attr('x3', '0%')
                .attr('y3', '100%')
                .attr('x4', '0%')
                .attr('y4', '100%');
            linearGradient.append('stop')
                .attr('offset', '0%')
                .style('stop-color', 'rgb(80, 166, 191)')
                .style('stop-opacity', '1');
            linearGradient.append('stop')
                .attr('offset', '50%')
                .style('stop-color', 'rgb(156, 196, 139)')
                .style('stop-opacity', '1');
            linearGradient.append('stop')
                .attr('offset', '90%')
                .style('stop-color', 'rgb(179, 157, 83)')
                .style('stop-opacity', '1');
            linearGradient.append('stop')
                .attr('offset', '100%')
                .style('stop-color', 'rgb(239, 232, 222)')
                .style('stop-opacity', '1');

            svg.selectAll('path.line')
                .data(data)
                .enter()
                .append('path')
                .classed('line', true)
                .style('fill', 'url(#mountain-color)')
                .style('stroke', '#000')
                .attr('d', d => line(d));

            // let svgSource = svg.attr("version", 1.1)
            //     .attr("xmlns", "http://www.w3.org/2000/svg")
            //     .node().parentNode.innerHTML;
            // console.log(svgSource)
            // d3.select("body").append("a")
            //     .attr("title", "file.svg")
            //     .attr("href-lang", "image/svg+xml")
            //     .attr(
            //         "href",
            //         "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgHeadInfo + svgSource)))
            //     )
            //     .text("保存");

            //get svg element.
            let svg11 = document.getElementById("svg");
            //get svg source.
            let serializer = new XMLSerializer();
            let source = serializer.serializeToString(svg11);

            //add name spaces
            if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            //add xml declaration
            source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

            //convert svg source to URI data scheme.
            let url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

            //set url value to a element's href attribute.
            document.getElementById("link").href = url;

        });
    </script>
</body>

</html>
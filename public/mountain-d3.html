<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Mountain-d3</title>
    <style>
        * {
            margin: 0;
            padding: 0
        }

        #link {
            position: absolute;
            left: 150px;
            top: 50px;
            display: block;
            background-color: brown;
            height: 60px;
            width: 60px;
            line-height: 60px;
            text-align: center;
            text-decoration: none;
            color: #fff;
            border-radius: 50%;
        }

        #city-block {
            position: absolute;
            right: 80px;
            top: 50px;
        }
    </style>
</head>

<body>
    <a href="" id="link">保存</a>
    <div id="city-block">
        <label for="city-select">城市：</label>
        <select name="city-select" id="city-select">
            <option value="shanghai">上海</option>
            <option value="lasa">拉萨</option>
            <option value="kunming">昆明</option>
            <option value="guiyang">贵阳</option>
            <option value="changsha">长沙</option>
            <option value="nanchang">南昌</option>
            <option value="hangzhou">杭州</option>
            <option value="chengdu">成都</option>
            <option value="chongqing">重庆</option>
            <option value="wuhan">武汉</option>
            <option value="hefei">合肥</option>
            <option value="nanjing">南京</option>
            <option value="haikou">海口</option>
            <option value="shijiazhuang">石家庄</option>
        </select>
        <label for="year-select">年份：</label>
        <select name="year-select" id="year-select">
            <option value="2013">2013</option>
            <option value="2014">2014</option>
            <option value="2015">2015</option>
            <option value="2016">2016</option>
            <option value="2017">2017</option>
            <option value="2018">2018</option>
            <option value="2019">2019</option>
        </select>
    </div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="./script/calcMonthlyData.js"></script>
    <script src="./script/getMonthData.js"></script>
    <script src="./script/extract_data/getYearData.js"></script>
    <script src="./script/extract_data/getAllMonthlyData.js"></script>
    <script>
        const svgHeadInfo =
            '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.0//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd" > ';
        let city = 'shanghai';
        let year = 2019;

        document.getElementById('city-block').onchange = e => {
            city = $('#city-select').val();
            year = $('#year-select').val();
            $('#main').remove();
            d3.csv('./data/' + city + '.csv').then(val => {
                console.log(year)
                let cooked_data = getAllMonthlyData(val);
                console.log(cooked_data);
                let d_min = Number.MAX_VALUE,
                    d_max = Number.MIN_VALUE,
                    most_polluted = Number.MIN_VALUE,
                    most_clean = Number.MAX_VALUE;
                for (let d of cooked_data) {
                    if (parseFloat(d[0]) > d_max) d_max = parseFloat(d[0]);
                    if (parseFloat(d[0]) < d_min) d_min = parseFloat(d[0]);
                    if (parseFloat(d[1]) > most_polluted) most_polluted = parseFloat(d[1]);
                    if (parseFloat(d[1]) < most_clean) most_clean = parseFloat(d[1]);
                }

                let data = [cooked_data];
                data[0].push([data[0][data[0].length - 1][0], most_polluted]);
                data[0].unshift([data[0][0][0], most_polluted]);
                let x = d3.scaleLinear().domain([d_min, d_max]).range([50, window.innerWidth - 50]),
                    y = d3.scaleLinear().domain([0, most_polluted]).range([100, 450]);
                let line = d3.line()
                    .x(d => x(d[0]))
                    .y(d => y(d[1]))

                let svg = d3.select('body').append('div').attr('id', 'main').append('svg')
                    .attr("xmlns:xlink", "http://www.w3.org/1999/xlink")
                    .attr('id', 'svg')
                    .attr('width', window.innerWidth)
                    .attr('height', window.innerHeight)
                    .style('background-color', 'rgb(239, 232, 222)');

                let linearGradient = svg.append('defs').append('linearGradient')
                    .attr('id', 'mountain-color')
                    .attr('x1', '0%')
                    .attr('y1', '0%')
                    .attr('x2', '0%')
                    .attr('y2', '100%');
                linearGradient.append('stop')
                    .attr('offset', parseInt((0 - most_clean) / (most_polluted - most_clean) * 100) + '%')
                    .style('stop-color', '#1685a9')
                    .style('stop-opacity', '1');
                linearGradient.append('stop')
                    .attr('offset', parseInt((100 - most_clean) / (most_polluted - most_clean) * 100) + '%')
                    .style('stop-color', '#76cfa6')
                    .style('stop-opacity', '1');
                // linearGradient.append('stop')
                //     .attr('offset', parseInt((150 - most_clean) / (most_polluted - most_clean) * 100) + '%')
                //     .style('stop-color', '#76cfa6')
                //     .style('stop-opacity', '1');
                linearGradient.append('stop')
                    .attr('offset', parseInt((200 - most_clean) / (most_polluted - most_clean) * 100) + '%')
                    .style('stop-color', '#a78e44')
                    .style('stop-opacity', '1');
                linearGradient.append('stop')
                    .attr('offset', parseInt((250 - most_clean) / (most_polluted - most_clean) * 100) + '%')
                    .style('stop-color', '#845a33')
                    .style('stop-opacity', '1');
                linearGradient.append('stop')
                    .attr('offset', '100%')
                    .style('stop-color', 'rgb(239, 232, 222)')
                    .style('stop-opacity', '1');

                svg.selectAll('path.line')
                    .data(data)
                    .enter()
                    .append('path')
                    .classed('line', true)
                    .style('fill', 'url(#mountain-color)')
                    .style('stroke', '#000')
                    .attr('d', d => line(d));

                let serializer = new XMLSerializer();
                let source = serializer.serializeToString(document.getElementById("svg"));

                //add name spaces
                if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    source = source.replace(/^<svg/,
                        '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }

                //add xml declaration
                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

                //convert svg source to URI data scheme.
                let url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

                //set url value to a element's href attribute.
                document.getElementById("link").href = url;
            });
        }

        // d3.csv('./data/' + city + '.csv').then(val => {
        //     let some_month_data = getMonthData(val, 2018, 12);
        //     let data = [some_month_data];
        //     data[0].push([data[0][data[0].length - 1][0], 300]);
        //     data[0].unshift([data[0][0][0], 300]);
        //     let x = d3.scaleLinear().domain([0, 25]).range([0, window.innerWidth - 300]),
        //         y = d3.scaleLinear().domain([0, 400]).range([50, 450]);

        //     let line = d3.line()
        //         .x(d => x(d[0]))
        //         .y(d => y(d[1]))

        //     let svg = d3.select('body').append('div').attr('id', 'main').append('svg')
        //         .attr("xmlns:xlink", "http://www.w3.org/1999/xlink")
        //         .attr('id', 'svg')
        //         .attr('width', window.innerWidth)
        //         .attr('height', window.innerHeight / 7 * 4)
        //         .style('background-color', 'rgb(239, 232, 222)');

        //     let linearGradient = svg.append('defs').append('linearGradient')
        //         .attr('id', 'mountain-color')
        //         .attr('x1', '0%')
        //         .attr('y1', '0%')
        //         .attr('x2', '0%')
        //         .attr('y2', '100%')
        //         .attr('x3', '0%')
        //         .attr('y3', '100%')
        //         .attr('x4', '0%')
        //         .attr('y4', '100%');
        //     linearGradient.append('stop')
        //         .attr('offset', '0%')
        //         .style('stop-color', 'rgb(80, 166, 191)')
        //         .style('stop-opacity', '1');
        //     linearGradient.append('stop')
        //         .attr('offset', '50%')
        //         .style('stop-color', 'rgb(156, 196, 139)')
        //         .style('stop-opacity', '1');
        //     linearGradient.append('stop')
        //         .attr('offset', '90%')
        //         .style('stop-color', 'rgb(179, 157, 83)')
        //         .style('stop-opacity', '1');
        //     linearGradient.append('stop')
        //         .attr('offset', '100%')
        //         .style('stop-color', 'rgb(239, 232, 222)')
        //         .style('stop-opacity', '1');

        //     svg.selectAll('path.line')
        //         .data(data)
        //         .enter()
        //         .append('path')
        //         .classed('line', true)
        //         .style('fill', 'url(#mountain-color)')
        //         .style('stroke', '#000')
        //         .attr('d', d => line(d));

        //     let serializer = new XMLSerializer();
        //     let source = serializer.serializeToString(document.getElementById("svg"));

        //     //add name spaces
        //     if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
        //         source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        //     }
        //     if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
        //         source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
        //     }

        //     //add xml declaration
        //     source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

        //     //convert svg source to URI data scheme.
        //     let url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

        //     //set url value to a element's href attribute.
        //     document.getElementById("link").href = url;

        // });
    </script>
</body>

</html>